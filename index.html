<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ライブをメモするLivelog</title>
</head>
<body>

<h1>Livelog</h1>

<hr>

<form name="form" onsubmit="return false;">

<select name="year" onChange="changeYear(this);">
<option value="2018">2018</option>
<option value="2017" selected>2017</option>
<option value="2016">2016</option>
<option value="2015">2015</option>
<option value="2014">2014</option>
</select>

<ul id="info">
</ul>

<button onclick="location.href='edit.html';">新規登録</button>
<p id="clear"></p>
<p id="export"></p>
<p id="import"><a href="import.html">インポート</a></p>

</form>

<hr>

<p>Developed on <a href="https://github.com/livelogjp/livelog-alpha">GitHub</a>.</p>

<script>

function $(id){return document.getElementById(id);}

//連想配列の値を指定した文字列で連結する関数
function arrayJoin(delimiter, object) {
  var ret = '';
  var lastkey = Object.keys(object).pop();
  for (var k in object) {
    ret += object[k] + (lastkey !== k ? delimiter : '');
  }
  return ret;
}

//ページをロードしたらライブ一覧表示を実行
displayList();

//プルダウンを選択したらライブ一覧表示を実行
function changeYear(obj){
  displayList();
}

//☆プルダウンで選択されている年のライブ一覧を表示する関数
function displayList() {

  //プルダウンで選択されている年を取得
  var year = document.form.year.value;

  //☆localStorageにデータが登録されていたら一覧表示する処理
  if(localStorage.length > 0) {

    //localStorageのKey-Valueを格納するための配列を生成
    var key = new Array();
    var allItem = new Array();

    //最初にライブ一覧の表示内容を初期化（プルダウン選択時のリロード対策）
    $('info').innerHTML = '';

    for(var i=0; i<localStorage.length; i++) {
      //localStorageのKey-Value値を各配列に代入
      key[i] = localStorage.key(i);
      allItem[i] = JSON.parse(
        localStorage.getItem(key[i])
      );
    }

    //localStorageから読み込んだデータから、選択中の年のデータだけ抽出
    var currentItem = allItem.filter(function(item, index){
      if ((item.date).indexOf(year) >= 0) return true;
    });

    //抽出したデータを日時が新しい順にソート
    currentItem.sort(function(a, b) {
      return ( a.date < b.date ? 1 : -1);
    });

    if (currentItem.length > 0) {
      //プルダウンで選択された年にライブが登録されていたら、日付が新しい順に一覧表示
      for(var i=0; i<currentItem.length; i++) {

        //artist0〜artist*の値を配列で取得
        var artistsItemLabel = Object.keys(currentItem[i].artists);

        //アーティスト名一覧を格納するための配列を作成
        var artistsItem = [];

        //アーティスト用の配列に登録されている分だけのアーティスト名を入力
        for (j = 0; j < artistsItemLabel.length; j++) {
          var currentArtsitLabel = 'artist' + j;
          artistsItem[j] = currentItem[i].artists[currentArtsitLabel].name;
        }

        //アーティスト名の配列をつなげて文字列に変換
        var artistsItemJoin = arrayJoin('、', artistsItem);

        $('info').innerHTML += '<li><p>' + currentItem[i].date + '</p><p>' + currentItem[i].title + '＠' + currentItem[i].area + ' ' + currentItem[i].place + '</p><p>OPEN ' + currentItem[i].open + ' / START ' + currentItem[i].start + '</p><p>出演：' + artistsItemJoin + '</p><p><a href="detail.html?live=' + currentItem[i].id + '">詳細</a></p></li>';

      }

    } else {
      //プルダウンで選択された年にライブが登録されていなかったら文言を表示
      $('info').innerHTML = '<li>ライブが登録されていません。</li>';
    }

    $('clear').innerHTML = '<button onclick="allDataClear();">データクリア</button>';
    $('export').innerHTML = '<a href="export.html">エクスポート</a>';

  } else {
    //データが登録されていなかったら文言を表示
    $('info').innerHTML = '<li>ライブが登録されていません。</li>';
  }

}


//☆データを全削除する処理
function allDataClear() {
  //確認ダイアログで「OK」を押したら処理を実行
  if(window.confirm('全てのライブ情報を削除してよろしいですか？')){
    window.localStorage.clear();
    //データ削除が終わったら、情報を最新化するためにリロード
    window.location.reload();
  }
}

</script>

</body>
</html>
